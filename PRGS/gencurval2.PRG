PROCEDURE GENCURVAL2
LPARAMETERS lbRecrear,lcTpDoc
	DO VerVars
	&&algoritmo medular 
	IF !USED("PR")
		*DO GENCURBASEPRESUP
		DO GENCURBASE
		DO SUMCURPR
		DO ADDNULO
		DO SUMFACT
		DO COMPLE_PREST
		DO CERRCURSTEMP
		DO SUMOI
		*DO PRESPRUEBA
	ELSE
		IF lbRecrear 
			*DO GENCURBASEPRESUP
			DO GENCURBASE
			DO SUMCURPR
			DO REFSUMCURPR
			DO ADDNULO
			DO SUMFACT
			DO COMPLE_PREST
			DO CERRCURSTEMP
			DO SUMOI
			*DO PRESPRUEBA
		ENDIF
	ENDIF
	SELECT PR  
ENDPROC 

*PROCEDURE GENCURBASEPRESUP
*	SELECT;
		IDPRESUP,;
		SUM(cantidad*PRECIO) as COSTO;
	FROM ;
		DETALLEPRESUPUESTO;
	WHERE ;
		CANTIDAD*PRECIO>0;
	GROUP BY ;
		1;
	INTO CURSOR ;
		stdetallePRESUP
*ENDPROC 


PROCEDURE GENCURBASE
	&&Cursor PR1 base para validar PRESUPS

	SELECT;
		PRESUPUESTOS.idpresup,;
		PRESUPUESTOS.idcliente,;
		PRESUPUESTOS.PROYECTO,;
		PRESUPUESTOS.SNETO	as Costo,;
		PRESUPUESTOS.SRIVA 	as RetencionIva,;
		PRESUPUESTOS.SIVA	as Iva,;
		PRESUPUESTOS.STOTAL as Monto;
	FROM ;
		presupuestos ;
	INTO CURSOR ;
		PR1
ENDPROC 


PROCEDURE SUMCURPR
	&&cursor PR sumarizado del cursor base ya con los totales de retencioniva, iva 
	&&La funcion Retiva evalua el proveedor para calcular una retencion de iva distinta segun el proveedor
	SELECT;
		CAST(PR1.idpresup AS C(10)) AS IDPRESUP,;
		CAST(PR1.idcliente AS C(10)) AS IDCLIENTE,;
		CAST(PR1.Proyecto AS C(40)) AS PROYECTO,;
		"•CLIENTE: "+PR1.IDCLIENTE+CHR(13)+ALLTRIM(CLIENTES.NOMBRE)+CHR(13)+;
		"•PROYECTO: "+PR1.PROYECTO+CHR(13)+ALLTRIM(PROYECTOS.NOMBRE) AS DSC,;
		CAST(SUM(PR1.Costo) AS NUMERIC(10,2)) 			as costo ,;
		CAST(SUM(PR1.RetencionIva) AS NUMERIC(10,2)) 	as RetencionIva,;
		CAST(SUM(PR1.Iva) AS NUMERIC(10,2)) 			as Iva,;
		CAST(SUM(PR1.Monto) AS NUMERIC(10,2)) 			as Monto;	
	FROM ;
		PR1 INNER JOIN CLIENTES ON PR1.IDCLIENTE=CLIENTES.IDCLIENTE INNER JOIN ;
		PROYECTOS ON PR1.Proyecto=PROYECTOS.IDPROYECTOS;		
	GROUP BY ;
		1,2,3,4;
	INTO CURSOR PR READWRITE 
	&&Indexando el cursor para que los seek's del grid funcionen 
	SELECT PR
	INDEX ON idpresup TAG idpresup
	INDEX ON idcliente TAG idcliente
	INDEX ON Proyecto TAG proyecto
ENDPROC 

PROCEDURE REFSUMCURPR
	SELECT;
		PR1.idpresup,;
		PR1.idcliente,;
		PR1.Proyecto,;
		"•CLIENTE: "+PR1.IDCLIENTE+CHR(13)+ALLTRIM(CLIENTES.NOMBRE)+CHR(13)+;
		"•PROYECTO: "+PR1.PROYECTO+CHR(13)+ALLTRIM(PROYECTOS.NOMBRE) AS DSC,;
		SUM(PR1.Costo) 			as costo,;
		SUM(PR1.RetencionIva) 	as RetencionIva,;
		SUM(PR1.Iva) 			as Iva,;
		SUM(PR1.Monto) 			as Monto;	
	FROM ;
		PR1 INNER JOIN CLIENTES ON PR1.IDCLIENTE=CLIENTES.IDCLIENTE INNER JOIN ;
		PROYECTOS ON PR1.Proyecto=PROYECTOS.IDPROYECTOS;		
	GROUP BY ;
		1,2,3,4;
	INTO CURSOR tempPR 
	&&refilando el cursor pr de  TempPr
	SET SAFETY OFF
	ZAP IN PR 
	SET SAFETY ON 
	SELECT PR 
	APPEND FROM DBF('tempPR' ) 
ENDPROC 

PROCEDURE ADDNULO
	&&Agregando linea de Anulado 
	INSERT INTO PR (IDPRESUP,COSTO,RETENCIONIVA,IVA,MONTO);
	VALUES ("ANULADO",0,0,0,0)
ENDPROC 

*Agregar facturas 
PROCEDURE SUMFACT
	SELECT;
		FACTURAS.IDVENTA AS IDPRESUP ,;
		FACTURAS.IDCLIENTE AS IDCLIENTE,;
		FACTURAS.numero AS PROYECTO,;
		FACTURAS.DESCRIPCION AS DSC ,;
		FACTURAS.SNETO AS COSTO,;
		FACTURAS.SRIVA  AS RETENCIONIVA,;
		FACTURAS.SIVA  AS IVA,;
		FACTURAS.STOTAL AS MONTO;		
	FROM ;
		FACTURAS ;
	WHERE ;
		!EMPTY(FACTURAS.NUMERO);
	INTO CURSOR ;
		TEMPFACT

	SELECT PR 
	*IF RECCOUNT("TEMPFACT")>0
		APPEND FROM DBF('TEMPFACT') 
	*ENDIF 
ENDPROC 
*Agregar Otros Ingresos 
PROCEDURE SUMOI
	lnCero=0.00000
	SELECT;
		OTRING.IDOTRING AS IDPRESUP ,;
		OTRING.IDCLIENTE AS IDCLIENTE,;
		OTRING_TP.DESCRIPCION AS PROYECTO,;
		OTRING.REF AS DSC ,;
		SUM(OTRING_D.CANTIDAD*OTRING_D.PRECIO) AS COSTO,;
		lnCero AS RETENCIONIVA,;
		lnCero AS IVA,;
		SUM(OTRING_D.CANTIDAD*OTRING_D.PRECIO) AS MONTO;		
	FROM ;
		OTRING 	INNER JOIN OTRING_D ON OTRING.IDOTRING=OTRING_D.IDOTRING;
				LEFT JOIN OTRING_TP ON OTRING.IDTPOTRING=OTRING_TP.IDTPOTRING;
	GROUP BY ;
		1,2,3,4;
	INTO CURSOR ;
		TEMPOI

	SELECT PR 
	*IF RECCOUNT("TEMPFACT")>0
		APPEND FROM DBF('TEMPOI') 
	*ENDIF 
ENDPROC 


PROCEDURE COMPLE_PREST
	GENCURVAL(.t.)
	SELECT  ;
		NORDEN AS IDPRESUP,;
		PROVEEDOR AS IDCLIENTE,;
		PROYECTO AS PROYECTO,;
		PROYECTO AS DSC,;
		COSTO,;
		RETENCIONIVA,;
		IVA,;
		MONTO;
	FROM ;
		OC;
	WHERE ;
		NORDEN IN (SELECT REFERENCIA FROM DETALLECARGOSBANCO WHERE SUBSTR(REFERENCIA,1,2)=="PT" OR SUBSTR(REFERENCIA,1,2)=="CP");
	INTO CURSOR ;
		COMPLE_PREST
	SELECT PR 
	*IF RECCOUNT("TEMPFACT")>0
		APPEND FROM DBF('COMPLE_PREST') 
	*ENDIF 
ENDPROC 

**PROCEDIMIENTO SE HIZO EN FORMA EXPERIMENTAL PARA VER RESULTADO DE CHR(13) SOBRE EDITBOXS
PROCEDURE PRESPRUEBA
	SELECT;
		IDPRESUP,;
		"•"+IDPRESUP+CHR(13)+;
		"•"+IDCLIENTE+CHR(13)+;
		"•"+DEPTO+CHR(13)+;
		"•"+DESCRIPCION+CHR(13)+;
		"•"+PROYECTO+CHR(13) AS DSC;
	FROM ;
		PRESUPUESTOS;
	INTO CURSOR ;
		PR2 READWRITE
ENDPROC 

PROCEDURE CERRCURSTEMP
	SELECT PR1 
	USE
ENDPROC 

PROCEDURE VerVars
	llVarType=VARTYPE(gRETIVA)="U" OR VARTYPE(gIVA)="U" OR VARTYPE(gRENTA)="U" OR VARTYPE(gRETIVA13)="U"
	IF llVarType
		DO CONFIGAPP 
	ENDIF 
ENDPROC


